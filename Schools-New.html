<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PVME Tracker">
    <meta name="theme-color" content="#eab308">
    <meta name="description" content="Military trainee photography order management by Pro Vision Multimedia Enterprises">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <title>PVME Picture Day Tracker</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        
        input, select, button {
            font-family: inherit;
        }
        
        input[type="checkbox"] {
            width: 24px;
            height: 24px;
            accent-color: #eab308;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: #1e293b;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #334155;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #1e293b;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .modal-close {
            background: #334155;
            border: none;
            color: #e2e8f0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .product-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #334155;
        }

        .product-row:last-child {
            border-bottom: none;
        }

        .product-name {
            font-weight: 500;
        }

        .product-count {
            font-weight: bold;
            color: #eab308;
            font-size: 18px;
        }

        .fulfillment-section {
            margin-bottom: 24px;
        }

        .fulfillment-title {
            font-size: 14px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #eab308;
        }

        .fulfillment-item {
            padding: 10px 0;
            border-bottom: 1px solid #334155;
            font-size: 14px;
        }

        .fulfillment-item:last-child {
            border-bottom: none;
        }

        .fulfillment-photo {
            color: #eab308;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // ============ FORM CONFIGURATION ============
        const FORM_CONFIG = {
            name: 'New Picture Day Order Form',
            formId: '253004946489061',
            packages: {
                'A': { name: 'Package A', desc: '8Ã—12 Class Group + 8Ã—10 Individual', price: 25, needsPhoto: true, products: ['Class Group 8x12', 'Individual 8x10'] },
                'B': { name: 'Package B', desc: '8Ã—12 Class Group', price: 20, needsPhoto: false, products: ['Class Group 8x12'] },
                'C': { name: 'Package C', desc: '8Ã—10 Individual', price: 20, needsPhoto: true, products: ['Individual 8x10'] },
                'D': { name: 'Package D', desc: '8Ã—10 Buddy Shot', price: 20, needsPhoto: true, products: ['Buddy Shot 8x10'] },
                'G1': { name: 'Package G1', desc: 'Mouse Pad', price: 15, needsPhoto: true, products: ['Mouse Pad'] },
                'G2': { name: 'Package G2', desc: 'Phone Socket Grip', price: 15, needsPhoto: true, products: ['Phone Socket Grip'] },
                'G3': { name: 'Package G3', desc: 'Dog Tag (Photo)', price: 15, needsPhoto: true, products: ['Dog Tag'] },
                'G4': { name: 'Package G4', desc: 'Bag Tag (3) Double-Sided', price: 30, needsPhoto: true, products: ['Bag Tag', 'Bag Tag', 'Bag Tag'] },
                'G5': { name: 'Package G5', desc: 'Bag Tag (1) Double-Sided', price: 12, needsPhoto: true, products: ['Bag Tag'] },
                'G6': { name: 'Package G6', desc: '11oz Mug (Full Wrap)', price: 15, needsPhoto: true, products: ['Mug 11oz'] },
                'G7': { name: 'Package G7', desc: '14oz Deluxe Travel Mug', price: 30, needsPhoto: true, products: ['Travel Mug 14oz'] }
            }
        };

        const CONFIG = {
            apiKey: 'af081af2c96a9cbb9b8e122986b113b5',
            taxRate: 0.06
        };

        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(() => {
                // Check if already authenticated this session
                return sessionStorage.getItem('pvme_authenticated') === 'true';
            });
            const [passwordInput, setPasswordInput] = useState('');
            const [passwordError, setPasswordError] = useState(false);
            
            const CORRECT_PASSWORD = 'Scout95**';
            
            const handleLogin = () => {
                if (passwordInput === CORRECT_PASSWORD) {
                    setIsAuthenticated(true);
                    sessionStorage.setItem('pvme_authenticated', 'true');
                    setPasswordError(false);
                } else {
                    setPasswordError(true);
                    setPasswordInput('');
                }
            };
            
            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            };
            
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [view, setView] = useState('shoot');
            const [expandedOrder, setExpandedOrder] = useState(null);
            const [showProductTotals, setShowProductTotals] = useState(false);
            const [showFulfillment, setShowFulfillment] = useState(false);
            const [showReviewModal, setShowReviewModal] = useState(false);
            const [reviewOrder, setReviewOrder] = useState(null);
            const [reviewPhone, setReviewPhone] = useState('');
            const [sendingReview, setSendingReview] = useState(false);
            const [reviewSent, setReviewSent] = useState({});
            
            const ZAPIER_WEBHOOK_URL = 'https://hooks.zapier.com/hooks/catch/18465231/ukukv0k/'; // Zapier webhook for review requests
            const GOOGLE_REVIEW_LINK = 'https://g.page/r/CYsNrNGwzgQIEBM/review';
            
            const [dayFilter, setDayFilter] = useState('all');
            const [platoonFilter, setPlatoonFilter] = useState('all');
            const [statusFilter, setStatusFilter] = useState('all');
            const [paymentFilter, setPaymentFilter] = useState('all');
            const [photoTypeFilter, setPhotoTypeFilter] = useState('all');
            const [searchQuery, setSearchQuery] = useState('');
            const [editingPriceId, setEditingPriceId] = useState(null);
            const [editingPriceValue, setEditingPriceValue] = useState('');
            const [addItemOrderId, setAddItemOrderId] = useState(null);
            const [showAddItemModal, setShowAddItemModal] = useState(false);
            
            const [localData, setLocalData] = useState(() => {
                try {
                    const saved = localStorage.getItem('pvme_tracker_data_v2');
                    return saved ? JSON.parse(saved) : {};
                } catch {
                    return {};
                }
            });

            useEffect(() => {
                try {
                    localStorage.setItem('pvme_tracker_data_v2', JSON.stringify(localData));
                } catch (e) {
                    console.error('Failed to save:', e);
                }
            }, [localData]);

            const parseOrders = (submissions) => {
                const PACKAGES = FORM_CONFIG.packages;
                return submissions.map(sub => {
                    const answers = sub.answers || {};
                    let name = '', platoon = '', drillSergeant = '', pictureDay = '',
                        packages = [], buddyName = '', email = '', phone = '', customRequest = '',
                        orderTotal = 0, graduationDate = '';

                    Object.keys(answers).forEach(key => {
                        const answer = answers[key];
                        const text = answer.text || '';
                        const value = answer.answer || '';

                        if (text.toLowerCase().includes('full name') || text.toLowerCase().includes('name')) {
                            // Handle name as string or object (first/last name fields)
                            if (typeof value === 'string') {
                                name = value;
                            } else if (typeof value === 'object' && value !== null) {
                                // Combine first and last name if it's an object
                                const first = value.first || value.firstName || '';
                                const last = value.last || value.lastName || '';
                                name = `${first} ${last}`.trim();
                                if (!name) {
                                    name = Object.values(value).filter(v => typeof v === 'string').join(' ').trim();
                                }
                            }
                        }
                        else if (text.toLowerCase().includes('platoon')) platoon = value;
                        else if (text.toLowerCase().includes('drill sergeant')) drillSergeant = value;
                        else if (text.toLowerCase().includes('picture day') || text.toLowerCase().includes('scheduled picture')) pictureDay = value;
                        else if (text.toLowerCase().includes('packages') || text.toLowerCase().includes('products')) {
                            // Handle different formats: array, string, or object
                            if (Array.isArray(value)) {
                                packages = value;
                            } else if (typeof value === 'string' && value) {
                                packages = [value];
                            } else if (typeof value === 'object' && value !== null) {
                                // If it's an object, try to extract values
                                packages = Object.values(value).filter(v => typeof v === 'string');
                            } else {
                                packages = [];
                            }
                        }
                        else if (text.toLowerCase().includes('buddy')) buddyName = value;
                        else if (text.toLowerCase().includes('email')) email = value;
                        else if (text.toLowerCase().includes('phone') || text.toLowerCase().includes('mobile') || text.toLowerCase().includes('cell')) {
                            if (typeof value === 'object' && value.full) {
                                phone = value.full;
                            } else if (typeof value === 'string') {
                                phone = value;
                            }
                        }
                        else if (text.toLowerCase().includes('special request') || text.toLowerCase().includes('custom') || text.toLowerCase().includes('additional comments')) customRequest = value;
                        else if (text.toLowerCase().includes('order total')) orderTotal = parseFloat(value) || 0;
                        else if (text.toLowerCase().includes('graduate')) graduationDate = value;
                    });

                    let parsedPackages = [];
                    try {
                        const seenCodes = new Set();
                        parsedPackages = packages.map(pkg => {
                            // Make sure pkg is a string
                            if (typeof pkg !== 'string') return null;
                            // Match "Package A", "Package G1", "A", "G1", etc.
                            const match = pkg.match(/Package\s*([A-Z]\d?)|^([A-Z]\d?)/i);
                            if (match) {
                                const code = (match[1] || match[2]).toUpperCase();
                                // Skip if we've already seen this package code
                                if (seenCodes.has(code)) return null;
                                seenCodes.add(code);
                                if (PACKAGES[code]) {
                                    return { code, raw: pkg, ...PACKAGES[code] };
                                }
                            }
                            return null;
                        }).filter(p => p && p.name);
                    } catch (e) {
                        console.error('Error parsing packages:', e, packages);
                        parsedPackages = [];
                    }

                    const subtotal = parsedPackages.reduce((sum, p) => sum + (p.price || 0), 0);
                    const tax = subtotal * CONFIG.taxRate;
                    const calculatedTotal = subtotal + tax;

                    return {
                        id: sub.id,
                        name,
                        platoon,
                        drillSergeant,
                        pictureDay,
                        packages: parsedPackages,
                        buddyName,
                        email,
                        phone,
                        customRequest,
                        orderTotal: orderTotal || calculatedTotal,
                        subtotal,
                        tax,
                        graduationDate,
                        createdAt: sub.created_at
                    };
                }).filter(o => o.name);
            };

            const loadOrders = async () => {
                setLoading(true);
                setError(null);
                
                try {
                    const response = await fetch(
                        `https://api.jotform.com/form/${FORM_CONFIG.formId}/submissions?apiKey=${CONFIG.apiKey}&limit=1000&filter=%7B%22status%22%3A%22ACTIVE%22%7D`
                    );
                    const data = await response.json();
                    
                    if (data.responseCode === 200) {
                        const parsed = parseOrders(data.content);
                        setOrders(parsed);
                    } else {
                        setError('Failed to load: ' + (data.message || 'Unknown error'));
                    }
                } catch (err) {
                    setError('Connection error: ' + err.message);
                }
                
                setLoading(false);
            };

            useEffect(() => {
                loadOrders();
            }, []);

            // Picture day override functions
            const getPictureDayOverride = (orderId) => {
                return localData[orderId]?.pictureDayOverride;
            };
            
            const setPictureDayOverride = (orderId, newDay) => {
                setLocalData(prev => ({
                    ...prev,
                    [orderId]: {
                        ...prev[orderId],
                        pictureDayOverride: newDay
                    }
                }));
            };
            
            const getDisplayPictureDay = (order) => {
                const override = getPictureDayOverride(order.id);
                if (override !== undefined) {
                    return override;
                }
                return order.pictureDay || '';
            };

            const filteredOrders = orders.filter(order => {
                // Skip hidden orders
                if (localData[order.id]?.hidden) return false;
                
                if (dayFilter !== 'all' && getDisplayPictureDay(order) !== dayFilter) return false;
                if (platoonFilter !== 'all' && order.platoon !== platoonFilter) return false;
                const isCompleted = localData[order.id]?.completed;
                const isPaid = localData[order.id]?.paid;
                if (statusFilter === 'pending' && isCompleted) return false;
                if (statusFilter === 'completed' && !isCompleted) return false;
                if (paymentFilter === 'paid' && !isPaid) return false;
                if (paymentFilter === 'unpaid' && isPaid) return false;
                if (searchQuery && !order.name.toLowerCase().includes(searchQuery.toLowerCase())) return false;
                
                // Photo type filter
                if (photoTypeFilter !== 'all') {
                    const hasPhotoType = order.packages.some(pkg => {
                        const code = pkg.code;
                        if (photoTypeFilter === 'individual') return ['A', 'C', 'F'].includes(code);
                        if (photoTypeFilter === 'buddy') return code === 'D';
                        if (photoTypeFilter === 'class') return ['A', 'B', 'E'].includes(code);
                        if (photoTypeFilter === 'products') return code.startsWith('G');
                        return false;
                    });
                    if (!hasPhotoType) return false;
                }
                
                return true;
            }).sort((a, b) => {
                const nameA = (a.name || '').toString();
                const nameB = (b.name || '').toString();
                return nameA.localeCompare(nameB);
            });

            const pictureDays = [...new Set(orders.map(o => getDisplayPictureDay(o)).filter(d => d))].sort();
            const platoons = [...new Set(orders.map(o => o.platoon).filter(p => p))].sort();

            const updatePhotoNumber = (orderId, pkgCode, value) => {
                setLocalData(prev => ({
                    ...prev,
                    [orderId]: {
                        ...prev[orderId],
                        photoNumbers: {
                            ...(prev[orderId]?.photoNumbers || {}),
                            [pkgCode]: value
                        }
                    }
                }));
            };

            const toggleComplete = (orderId) => {
                setLocalData(prev => ({
                    ...prev,
                    [orderId]: {
                        ...prev[orderId],
                        completed: !prev[orderId]?.completed
                    }
                }));
            };

            const togglePaid = (orderId) => {
                const wasUnpaid = !localData[orderId]?.paid;
                
                setLocalData(prev => ({
                    ...prev,
                    [orderId]: {
                        ...prev[orderId],
                        paid: !prev[orderId]?.paid
                    }
                }));
                
                // If marking as paid (not unpaid), show review modal
                if (wasUnpaid) {
                    const order = orders.find(o => o.id === orderId);
                    if (order && !reviewSent[orderId]) {
                        setReviewOrder(order);
                        setReviewPhone(order.phone || '');
                        setShowReviewModal(true);
                    }
                }
            };
            
            const sendReviewRequest = async () => {
                if (!reviewPhone || !reviewOrder) return;
                
                setSendingReview(true);
                
                try {
                    await fetch(ZAPIER_WEBHOOK_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            phone: reviewPhone,
                            name: reviewOrder.name,
                            reviewLink: GOOGLE_REVIEW_LINK,
                            message: `We appreciate a review: ${GOOGLE_REVIEW_LINK} . Thank you for trusting us.`
                        })
                    });
                    
                    // Mark as sent
                    setReviewSent(prev => ({
                        ...prev,
                        [reviewOrder.id]: true
                    }));
                    
                    setShowReviewModal(false);
                    setReviewOrder(null);
                    setReviewPhone('');
                    
                    alert('Review request sent!');
                } catch (error) {
                    alert('Failed to send. Please try again.');
                }
                
                setSendingReview(false);
            };
            
            const skipReview = () => {
                setShowReviewModal(false);
                setReviewOrder(null);
                setReviewPhone('');
            };

            const getPhotoNumber = (orderId, pkgCode) => {
                return localData[orderId]?.photoNumbers?.[pkgCode] || '';
            };

            const isCompleted = (orderId) => localData[orderId]?.completed || false;
            const isPaid = (orderId) => localData[orderId]?.paid || false;
            
            // Price override functions
            const getPriceOverride = (orderId) => {
                return localData[orderId]?.priceOverride;
            };
            
            const setPriceOverride = (orderId, subtotal) => {
                const tax = subtotal * CONFIG.taxRate;
                const total = subtotal + tax;
                setLocalData(prev => ({
                    ...prev,
                    [orderId]: {
                        ...prev[orderId],
                        priceOverride: {
                            subtotal: subtotal,
                            tax: tax,
                            total: total
                        }
                    }
                }));
            };
            
            const clearPriceOverride = (orderId) => {
                setLocalData(prev => {
                    const newData = { ...prev };
                    if (newData[orderId]) {
                        delete newData[orderId].priceOverride;
                    }
                    return newData;
                });
            };
            
            const getDisplayTotal = (order) => {
                const override = getPriceOverride(order.id);
                if (override) {
                    return override.total;
                }
                // Include added items in total
                const addedItems = getAddedItems(order.id);
                if (addedItems.length > 0) {
                    const addedSubtotal = addedItems.reduce((sum, item) => sum + item.price, 0);
                    const addedTax = addedSubtotal * CONFIG.taxRate;
                    return order.orderTotal + addedSubtotal + addedTax;
                }
                return order.orderTotal;
            };
            
            // Added items functions
            const getAddedItems = (orderId) => {
                return localData[orderId]?.addedItems || [];
            };
            
            const addItemToOrder = (orderId, packageCode) => {
                const PACKAGES = FORM_CONFIG.packages;
                const pkg = PACKAGES[packageCode];
                if (!pkg) return;
                
                const newItem = {
                    code: packageCode,
                    ...pkg,
                    addedOnSpot: true,
                    addedAt: new Date().toISOString()
                };
                
                setLocalData(prev => ({
                    ...prev,
                    [orderId]: {
                        ...prev[orderId],
                        addedItems: [...(prev[orderId]?.addedItems || []), newItem]
                    }
                }));
                
                setShowAddItemModal(false);
                setAddItemOrderId(null);
            };
            
            const removeAddedItem = (orderId, index) => {
                setLocalData(prev => {
                    const currentItems = prev[orderId]?.addedItems || [];
                    const newItems = currentItems.filter((_, i) => i !== index);
                    return {
                        ...prev,
                        [orderId]: {
                            ...prev[orderId],
                            addedItems: newItems
                        }
                    };
                });
            };
            
            // Hide/delete an order from view (doesn't delete from Jotform)
            const hideOrder = (orderId) => {
                if (confirm('Hide this order from the tracker? (This won\'t delete it from Jotform)')) {
                    setLocalData(prev => ({
                        ...prev,
                        [orderId]: {
                            ...prev[orderId],
                            hidden: true
                        }
                    }));
                }
            };
            
            // Delete order from BOTH local AND Jotform
            const deleteOrder = async (orderId, orderName) => {
                if (confirm(`DELETE "${orderName}" permanently?\n\nThis will:\nâ€¢ Remove from this tracker\nâ€¢ Delete from Jotform\n\nThis cannot be undone!`)) {
                    try {
                        // Delete from Jotform
                        const response = await fetch(
                            `https://api.jotform.com/submission/${orderId}?apiKey=${CONFIG.apiKey}`,
                            { method: 'DELETE' }
                        );
                        const data = await response.json();
                        
                        if (data.responseCode === 200) {
                            // Remove from local state
                            setOrders(prev => prev.filter(o => o.id !== orderId));
                            // Clean up local data
                            setLocalData(prev => {
                                const newData = { ...prev };
                                delete newData[orderId];
                                return newData;
                            });
                            alert('Order deleted successfully!');
                        } else {
                            alert('Failed to delete from Jotform: ' + (data.message || 'Unknown error'));
                        }
                    } catch (err) {
                        alert('Error deleting: ' + err.message);
                    }
                }
            };
            
            const unhideOrder = (orderId) => {
                setLocalData(prev => ({
                    ...prev,
                    [orderId]: {
                        ...prev[orderId],
                        hidden: false
                    }
                }));
            };
            
            const isHidden = (orderId) => localData[orderId]?.hidden || false;
            
            const getAddedItemPhotoNumber = (orderId, index) => {
                return localData[orderId]?.addedItemPhotos?.[index] || '';
            };
            
            const setAddedItemPhotoNumber = (orderId, index, value) => {
                setLocalData(prev => ({
                    ...prev,
                    [orderId]: {
                        ...prev[orderId],
                        addedItemPhotos: {
                            ...(prev[orderId]?.addedItemPhotos || {}),
                            [index]: value
                        }
                    }
                }));
            };

            // Calculate product totals
            const getProductTotals = () => {
                const totals = {};
                filteredOrders.forEach(order => {
                    // Original packages
                    order.packages.forEach(pkg => {
                        if (pkg.products) {
                            pkg.products.forEach(product => {
                                totals[product] = (totals[product] || 0) + 1;
                            });
                        }
                    });
                    // Added items
                    const addedItems = getAddedItems(order.id);
                    addedItems.forEach(item => {
                        if (item.products) {
                            item.products.forEach(product => {
                                totals[product] = (totals[product] || 0) + 1;
                            });
                        }
                    });
                });
                return totals;
            };

            // Generate fulfillment list by product
            const getFulfillmentData = () => {
                const byProduct = {};
                
                filteredOrders.forEach(order => {
                    // Original packages
                    order.packages.forEach(pkg => {
                        if (pkg.products) {
                            const photoNum = getPhotoNumber(order.id, pkg.code);
                            pkg.products.forEach(product => {
                                if (!byProduct[product]) {
                                    byProduct[product] = [];
                                }
                                byProduct[product].push({
                                    name: order.name,
                                    photoNumber: photoNum,
                                    packageCode: pkg.code,
                                    buddyName: pkg.code === 'D' ? order.buddyName : null
                                });
                            });
                        }
                    });
                    // Added items
                    const addedItems = getAddedItems(order.id);
                    addedItems.forEach((item, idx) => {
                        if (item.products) {
                            const photoNum = getAddedItemPhotoNumber(order.id, idx);
                            item.products.forEach(product => {
                                if (!byProduct[product]) {
                                    byProduct[product] = [];
                                }
                                byProduct[product].push({
                                    name: order.name + ' (ADDED)',
                                    photoNumber: photoNum,
                                    packageCode: item.code,
                                    buddyName: item.code === 'D' ? order.buddyName : null
                                });
                            });
                        }
                    });
                });

                // Sort each product's list by name
                Object.keys(byProduct).forEach(product => {
                    byProduct[product].sort((a, b) => {
                        const nameA = (a.name || '').toString();
                        const nameB = (b.name || '').toString();
                        return nameA.localeCompare(nameB);
                    });
                });

                return byProduct;
            };

            const stats = {
                total: orders.length,
                filtered: filteredOrders.length,
                completed: filteredOrders.filter(o => isCompleted(o.id)).length,
                pending: filteredOrders.filter(o => !isCompleted(o.id)).length,
                revenue: filteredOrders.reduce((sum, o) => sum + getDisplayTotal(o), 0),
                collected: filteredOrders.filter(o => isPaid(o.id)).reduce((sum, o) => sum + getDisplayTotal(o), 0),
                outstanding: filteredOrders.filter(o => !isPaid(o.id)).reduce((sum, o) => sum + getDisplayTotal(o), 0),
                paidCount: filteredOrders.filter(o => isPaid(o.id)).length,
                unpaidCount: filteredOrders.filter(o => !isPaid(o.id)).length
            };

            const exportCSV = () => {
                const rows = filteredOrders.map(o => {
                    const photoNums = Object.entries(localData[o.id]?.photoNumbers || {})
                        .filter(([k, v]) => v)
                        .map(([k, v]) => `${k}:${v}`).join('; ');
                    return [
                        o.name,
                        o.platoon,
                        getDisplayPictureDay(o),
                        o.packages.map(p => p.code).join(', '),
                        photoNums,
                        o.orderTotal.toFixed(2),
                        isCompleted(o.id) ? 'Yes' : 'No',
                        isPaid(o.id) ? 'Yes' : 'No',
                        o.buddyName,
                        o.email
                    ].map(v => `"${v || ''}"`).join(',');
                });
                
                const csv = ['Name,Platoon,PictureDay,Packages,PhotoNumbers,Total,Completed,Paid,BuddyName,Email', ...rows].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pvme_orders_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const exportFulfillment = () => {
                const fulfillment = getFulfillmentData();
                let csv = 'Product,Name,Photo Number,Buddy Name\n';
                
                Object.keys(fulfillment).sort().forEach(product => {
                    fulfillment[product].forEach(item => {
                        csv += `"${product}","${item.name}","${item.photoNumber || ''}","${item.buddyName || ''}"\n`;
                    });
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pvme_fulfillment_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const clearData = () => {
                if (confirm('Clear all photo numbers, completion, and payment status? This cannot be undone.')) {
                    setLocalData({});
                    localStorage.removeItem('pvme_tracker_data_v2');
                }
            };

            const generateSMSReport = () => {
                if (filteredOrders.length === 0) {
                    alert('No orders to report. Apply filters first.');
                    return;
                }
                
                // Build header info
                const currentDay = dayFilter || 'All Days';
                const currentPlatoon = platoonFilter || 'All Platoons';
                
                let report = `PVME Picture Day Report\n`;
                report += `ðŸ“… ${currentDay}\n`;
                report += `ðŸŽ–ï¸ ${currentPlatoon}\n`;
                report += `ðŸ“Š ${filteredOrders.length} Orders\n`;
                report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
                
                // Sort orders by name
                const sortedOrders = [...filteredOrders].sort((a, b) => {
                    const nameA = (a.name || '').toString();
                    const nameB = (b.name || '').toString();
                    return nameA.localeCompare(nameB);
                });
                
                // Build order list
                sortedOrders.forEach((order, index) => {
                    // Get all packages including added items
                    const originalPkgs = order.packages.map(p => p.name);
                    const addedItems = getAddedItems(order.id);
                    const addedPkgs = addedItems.map(p => `${p.name} (added)`);
                    const allPkgs = [...originalPkgs, ...addedPkgs];
                    
                    // Get individual total
                    const individualTotal = getDisplayTotal(order);
                    
                    report += `${index + 1}. ${order.name}\n`;
                    report += `   ${allPkgs.join(', ')}\n`;
                    report += `   ðŸ’µ $${individualTotal.toFixed(2)}\n\n`;
                });
                
                report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                report += `- PVME "We Got You"`;
                
                // Check if mobile device
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                if (isMobile) {
                    // Open SMS app with pre-filled message
                    const encodedReport = encodeURIComponent(report);
                    window.location.href = `sms:?&body=${encodedReport}`;
                } else {
                    // Desktop: copy to clipboard
                    navigator.clipboard.writeText(report).then(() => {
                        alert('ðŸ“‹ Report copied to clipboard!\n\nPaste it into Messages, email, or any app.');
                    }).catch(() => {
                        // Fallback for older browsers
                        const textarea = document.createElement('textarea');
                        textarea.value = report;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        alert('ðŸ“‹ Report copied to clipboard!\n\nPaste it into Messages, email, or any app.');
                    });
                }
            };

            const styles = {
                header: {
                    background: '#1e293b',
                    color: '#e2e8f0',
                    padding: '16px',
                    position: 'sticky',
                    top: 0,
                    zIndex: 100,
                    borderBottom: '3px solid #eab308'
                },
                title: { fontSize: '20px', fontWeight: 'bold', marginBottom: '4px', color: '#eab308' },
                subtitle: { fontSize: '12px', color: '#94a3b8' },
                btnGroup: { display: 'flex', gap: '8px', marginTop: '12px', flexWrap: 'wrap' },
                btn: {
                    background: '#334155',
                    color: '#e2e8f0',
                    border: 'none',
                    padding: '10px 14px',
                    borderRadius: '8px',
                    fontSize: '12px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px'
                },
                statsBar: {
                    display: 'flex',
                    gap: '12px',
                    padding: '12px 16px',
                    background: '#0f172a',
                    borderBottom: '1px solid #334155',
                    overflowX: 'auto',
                    flexWrap: 'wrap'
                },
                stat: { textAlign: 'center', minWidth: '55px' },
                statValue: { fontSize: '18px', fontWeight: 'bold', color: '#fbbf24' },
                statValueGreen: { fontSize: '18px', fontWeight: 'bold', color: '#4ade80' },
                statValueRed: { fontSize: '18px', fontWeight: 'bold', color: '#f87171' },
                statLabel: { fontSize: '9px', color: '#94a3b8', textTransform: 'uppercase', letterSpacing: '0.5px' },
                filters: {
                    padding: '12px 16px',
                    background: '#0f172a',
                    display: 'flex',
                    gap: '8px',
                    flexWrap: 'wrap',
                    alignItems: 'center',
                    borderBottom: '1px solid #334155'
                },
                select: {
                    background: '#1e293b',
                    border: '1px solid #334155',
                    color: '#e2e8f0',
                    padding: '8px 10px',
                    borderRadius: '6px',
                    fontSize: '12px'
                },
                searchInput: {
                    background: '#0f172a',
                    border: '1px solid #334155',
                    color: '#e2e8f0',
                    padding: '8px 12px',
                    borderRadius: '6px',
                    fontSize: '13px',
                    flex: 1,
                    minWidth: '100px'
                },
                viewToggle: {
                    display: 'flex',
                    borderRadius: '6px',
                    overflow: 'hidden',
                    border: '1px solid #0f172a'
                },
                viewBtn: (active) => ({
                    padding: '8px 12px',
                    background: active ? '#fbbf24' : '#1e293b',
                    color: active ? '#0f172a' : '#e2e8f0',
                    border: 'none',
                    cursor: 'pointer',
                    fontSize: '11px',
                    fontWeight: '600'
                }),
                ordersList: { padding: '8px 16px', display: 'flex', flexDirection: 'column', gap: '0' },
                orderCard: (completed) => ({
                    background: 'transparent',
                    borderRadius: '0',
                    border: 'none',
                    opacity: 1,
                    overflow: 'hidden',
                    borderLeft: completed ? '4px solid #4ade80' : 'none',
                    paddingLeft: completed ? '12px' : '0',
                    backgroundColor: completed ? 'rgba(34, 197, 94, 0.1)' : 'transparent'
                }),
                orderHeader: {
                    padding: '10px 0',
                    cursor: 'pointer',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'flex-start'
                },
                orderName: { fontSize: '20px', fontWeight: '700', color: '#ffffff' },
                badge: (type) => ({
                    display: 'inline-block',
                    padding: '3px 10px',
                    borderRadius: '12px',
                    fontSize: '11px',
                    fontWeight: '700',
                    marginLeft: '8px',
                    background: type === 'done' ? '#22c55e' : type === 'paid' ? '#3b82f6' : '#fbbf24',
                    color: type === 'done' ? '#fff' : type === 'paid' ? '#fff' : '#0f172a'
                }),
                orderMeta: {
                    display: 'flex',
                    gap: '16px',
                    fontSize: '15px',
                    color: '#fbbf24',
                    marginTop: '4px',
                    flexWrap: 'wrap',
                    fontWeight: '500'
                },
                orderTotal: { fontSize: '18px', fontWeight: 'bold', color: '#fbbf24' },
                orderBody: { padding: '8px 16px 16px', borderTop: 'none', background: '#1e293b', marginTop: '8px', borderRadius: '8px' },
                packageItem: {
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    padding: '12px 0',
                    borderBottom: '1px solid #334155'
                },
                packageInfo: { flex: 1 },
                packageName: { fontWeight: '700', fontSize: '16px', color: '#ffffff' },
                packageDesc: { fontSize: '14px', color: '#fbbf24' },
                packagePrice: { color: '#fbbf24', fontWeight: '700', minWidth: '50px', textAlign: 'right', fontSize: '16px' },
                photoInput: {
                    width: '70px',
                    padding: '8px 10px',
                    background: '#0f172a',
                    border: '2px solid #fbbf24',
                    borderRadius: '6px',
                    color: '#fff',
                    fontSize: '14px',
                    fontWeight: '600',
                    textAlign: 'center'
                },
                noPhoto: { fontSize: '10px', color: '#475569', width: '70px', textAlign: 'center' },
                buddyBox: {
                    background: '#0f172a',
                    padding: '10px 12px',
                    borderRadius: '6px',
                    marginTop: '12px'
                },
                buddyLabel: { fontSize: '10px', color: '#64748b', textTransform: 'uppercase', marginBottom: '4px' },
                actionBtns: { display: 'flex', gap: '8px', marginTop: '12px' },
                completeBtn: (done) => ({
                    flex: 1,
                    padding: '12px',
                    background: done ? '#475569' : '#22c55e',
                    color: '#fff',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer'
                }),
                paidBtn: (paid) => ({
                    flex: 1,
                    padding: '12px',
                    background: paid ? '#1d4ed8' : '#0f172a',
                    color: paid ? '#fff' : '#3b82f6',
                    border: paid ? 'none' : '2px solid #3b82f6',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer'
                }),
                deliveryCard: {
                    background: '#1e293b',
                    borderRadius: '12px',
                    padding: '16px',
                    border: '1px solid #334155'
                },
                emptyState: { textAlign: 'center', padding: '60px 20px', color: '#64748b' }
            };

            const productTotals = getProductTotals();
            const fulfillmentData = getFulfillmentData();

            // Login Screen
            if (!isAuthenticated) {
                return (
                    <div style={{
                        minHeight: '100vh',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        background: '#0f172a',
                        padding: '20px'
                    }}>
                        <div style={{
                            background: '#1e293b',
                            padding: '40px',
                            borderRadius: '16px',
                            textAlign: 'center',
                            maxWidth: '400px',
                            width: '100%',
                            border: '1px solid #334155'
                        }}>
                            <div style={{fontSize: '48px', marginBottom: '16px'}}>ðŸ“¸</div>
                            <h1 style={{fontSize: '24px', marginBottom: '8px', color: '#eab308'}}>PVME Tracker</h1>
                            <p style={{color: '#64748b', marginBottom: '24px'}}>Enter password to continue</p>
                            
                            <input
                                type="password"
                                value={passwordInput}
                                onChange={e => setPasswordInput(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="Password"
                                style={{
                                    width: '100%',
                                    padding: '14px',
                                    background: '#0f172a',
                                    border: passwordError ? '2px solid #ef4444' : '2px solid #334155',
                                    borderRadius: '8px',
                                    color: '#fff',
                                    fontSize: '16px',
                                    textAlign: 'center',
                                    marginBottom: '16px'
                                }}
                            />
                            
                            {passwordError && (
                                <p style={{color: '#ef4444', fontSize: '14px', marginBottom: '16px'}}>
                                    Incorrect password. Try again.
                                </p>
                            )}
                            
                            <button
                                onClick={handleLogin}
                                style={{
                                    width: '100%',
                                    padding: '14px',
                                    background: '#eab308',
                                    color: '#0f172a',
                                    border: 'none',
                                    borderRadius: '8px',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    cursor: 'pointer'
                                }}
                            >
                                Enter
                            </button>
                        </div>
                    </div>
                );
            }
            
            return (
                <div>
                    {/* Header */}
                    <div style={styles.header}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', flexWrap: 'wrap', gap: '10px'}}>
                            <div>
                                <div style={styles.title}>ðŸ“¸ PVME Picture Day Tracker</div>
                                <div style={styles.subtitle}>Pro Vision Multimedia Enterprises â€” "We Got You"</div>
                            </div>
                        </div>
                        <div style={styles.btnGroup}>
                            <button style={styles.btn} onClick={loadOrders} disabled={loading}>
                                {loading ? 'â³' : 'ðŸ”„'} {loading ? 'Loading...' : 'Refresh'}
                            </button>
                            <button style={styles.btn} onClick={() => setShowProductTotals(true)}>
                                ðŸ“¦ Order Totals
                            </button>
                            <button style={styles.btn} onClick={() => setShowFulfillment(true)}>
                                ðŸ“‹ Fulfillment
                            </button>
                            <button style={{...styles.btn, background: '#1e3a5f', color: '#60a5fa'}} onClick={generateSMSReport}>
                                ðŸ“¨ SMS Report
                            </button>
                            <button style={styles.btn} onClick={exportCSV}>
                                ðŸ’¾ Export
                            </button>
                            <button style={{...styles.btn, background: '#7f1d1d', color: '#fca5a5'}} onClick={clearData}>
                                ðŸ—‘ï¸
                            </button>
                        </div>
                    </div>

                    {/* Stats */}
                    <div style={styles.statsBar}>
                        <div style={styles.stat}>
                            <div style={styles.statValue}>{stats.filtered}</div>
                            <div style={styles.statLabel}>Showing</div>
                        </div>
                        <div style={styles.stat}>
                            <div style={styles.statValue}>{stats.completed}</div>
                            <div style={styles.statLabel}>Shot</div>
                        </div>
                        <div style={styles.stat}>
                            <div style={styles.statValue}>{stats.pending}</div>
                            <div style={styles.statLabel}>Pending</div>
                        </div>
                        <div style={styles.stat}>
                            <div style={styles.statValue}>${stats.revenue.toFixed(0)}</div>
                            <div style={styles.statLabel}>Total</div>
                        </div>
                        <div style={styles.stat}>
                            <div style={styles.statValueGreen}>${stats.collected.toFixed(0)}</div>
                            <div style={styles.statLabel}>Collected</div>
                        </div>
                        <div style={styles.stat}>
                            <div style={styles.statValueRed}>${stats.outstanding.toFixed(0)}</div>
                            <div style={styles.statLabel}>Owed</div>
                        </div>
                    </div>

                    {/* Filters */}
                    <div style={styles.filters}>
                        <select style={styles.select} value={dayFilter} onChange={e => setDayFilter(e.target.value)}>
                            <option value="all">All Days</option>
                            {pictureDays.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>
                        
                        <select style={styles.select} value={platoonFilter} onChange={e => setPlatoonFilter(e.target.value)}>
                            <option value="all">All Platoons</option>
                            {platoons.map(p => <option key={p} value={p}>{p}</option>)}
                        </select>
                        
                        <select style={styles.select} value={statusFilter} onChange={e => setStatusFilter(e.target.value)}>
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Shot</option>
                        </select>

                        <select style={styles.select} value={paymentFilter} onChange={e => setPaymentFilter(e.target.value)}>
                            <option value="all">All Payments</option>
                            <option value="paid">Paid</option>
                            <option value="unpaid">Unpaid</option>
                        </select>
                        
                        <input
                            type="text"
                            placeholder="Search..."
                            style={styles.searchInput}
                            value={searchQuery}
                            onChange={e => setSearchQuery(e.target.value)}
                        />
                        
                        <div style={styles.viewToggle}>
                            <button style={styles.viewBtn(view === 'shoot')} onClick={() => setView('shoot')}>Shoot</button>
                            <button style={styles.viewBtn(view === 'delivery')} onClick={() => setView('delivery')}>Delivery</button>
                        </div>
                    </div>

                    {/* Photo Type Filter Buttons */}
                    <div style={{
                        display: 'flex',
                        gap: '8px',
                        padding: '12px 16px',
                        background: '#0f172a',
                        borderBottom: '1px solid #334155',
                        overflowX: 'auto',
                        flexWrap: 'wrap'
                    }}>
                        <span style={{color: '#64748b', fontSize: '12px', alignSelf: 'center', marginRight: '8px'}}>Photo Type:</span>
                        {[
                            { key: 'all', label: 'ðŸ“· All' },
                            { key: 'individual', label: 'ðŸ‘¤ Individual' },
                            { key: 'buddy', label: 'ðŸ‘¥ Buddy' },
                            { key: 'class', label: 'ðŸŽ“ Class Group' },
                            { key: 'products', label: 'ðŸŽ Products' }
                        ].map(type => (
                            <button
                                key={type.key}
                                onClick={() => setPhotoTypeFilter(type.key)}
                                style={{
                                    padding: '8px 14px',
                                    background: photoTypeFilter === type.key ? '#fbbf24' : '#334155',
                                    color: photoTypeFilter === type.key ? '#0f172a' : '#e2e8f0',
                                    border: 'none',
                                    borderRadius: '20px',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    whiteSpace: 'nowrap'
                                }}
                            >
                                {type.label}
                            </button>
                        ))}
                    </div>

                    {/* Error */}
                    {error && (
                        <div style={{margin: '16px', padding: '16px', background: '#7f1d1d', borderRadius: '8px', color: '#fca5a5'}}>
                            {error}
                            <button onClick={loadOrders} style={{marginLeft: '12px', color: '#fbbf24', background: 'none', border: 'none', textDecoration: 'underline', cursor: 'pointer'}}>
                                Try Again
                            </button>
                        </div>
                    )}

                    {/* Orders */}
                    <div style={styles.ordersList}>
                        {loading && orders.length === 0 ? (
                            <div style={styles.emptyState}>
                                <div style={{fontSize: '40px', marginBottom: '16px'}}>â³</div>
                                <div>Loading orders from Jotform...</div>
                            </div>
                        ) : filteredOrders.length === 0 ? (
                            <div style={styles.emptyState}>
                                <div style={{fontSize: '40px', marginBottom: '16px'}}>ðŸ“­</div>
                                <div>No orders found</div>
                            </div>
                        ) : view === 'shoot' ? (
                            filteredOrders.map(order => (
                                <div key={order.id} style={styles.orderCard(isCompleted(order.id))}>
                                    <div style={styles.orderHeader} onClick={() => setExpandedOrder(expandedOrder === order.id ? null : order.id)}>
                                        <div>
                                            <div>
                                                <span style={styles.orderName}>{order.name}</span>
                                                {isCompleted(order.id) && <span style={styles.badge('done')}>âœ“ Shot</span>}
                                                {isPaid(order.id) && <span style={styles.badge('paid')}>ðŸ’µ Paid</span>}
                                                {!isCompleted(order.id) && !isPaid(order.id) && <span style={styles.badge('pending')}>Pending</span>}
                                            </div>
                                            <div style={styles.orderMeta}>
                                                <span>ðŸ“… {getDisplayPictureDay(order) || 'No date'}</span>
                                                <span>ðŸŽ–ï¸ {order.platoon || 'N/A'}</span>
                                                <span>ðŸ“¦ {order.packages.length}</span>
                                            </div>
                                        </div>
                                        <div style={{textAlign: 'right'}}>
                                            {isPaid(order.id) && <div style={{fontSize: '10px', color: '#22c55e'}}>PAID</div>}
                                        </div>
                                    </div>
                                    
                                    {expandedOrder === order.id && (
                                        <div style={styles.orderBody}>
                                            {order.packages
                                                .filter(pkg => {
                                                    // If no filter, show all packages
                                                    if (photoTypeFilter === 'all') return true;
                                                    const code = pkg.code;
                                                    // Only show packages matching the current filter
                                                    if (photoTypeFilter === 'individual') return ['A', 'C', 'F'].includes(code);
                                                    if (photoTypeFilter === 'buddy') return code === 'D';
                                                    if (photoTypeFilter === 'class') return ['A', 'B', 'E'].includes(code);
                                                    if (photoTypeFilter === 'products') return code.startsWith('G');
                                                    return true;
                                                })
                                                .map(pkg => {
                                                    // Determine if this specific view needs a photo number
                                                    // Class Group filter = no photo numbers needed
                                                    // Individual/Buddy/Products = needs photo number based on pkg.needsPhoto
                                                    const showPhotoInput = photoTypeFilter === 'class' ? false : pkg.needsPhoto;
                                                    
                                                    // Customize the description based on filter
                                                    let displayDesc = pkg.desc;
                                                    if (photoTypeFilter === 'class' && pkg.code === 'A') {
                                                        displayDesc = '8Ã—12 Class Group';
                                                    } else if (photoTypeFilter === 'individual' && pkg.code === 'A') {
                                                        displayDesc = '8Ã—10 Individual';
                                                    }
                                                    
                                                    return (
                                                <div key={pkg.code} style={styles.packageItem}>
                                                    <input
                                                        type="checkbox"
                                                        checked={!!getPhotoNumber(order.id, pkg.code)}
                                                        onChange={() => {}}
                                                    />
                                                    <div style={styles.packageInfo}>
                                                        <div style={styles.packageName}>{pkg.name}</div>
                                                        <div style={styles.packageDesc}>{displayDesc}</div>
                                                    </div>
                                                    <div style={styles.packagePrice}>${pkg.price}</div>
                                                    {showPhotoInput ? (
                                                        <input
                                                            type="text"
                                                            placeholder="#"
                                                            style={styles.photoInput}
                                                            value={getPhotoNumber(order.id, pkg.code)}
                                                            onChange={e => updatePhotoNumber(order.id, pkg.code, e.target.value)}
                                                        />
                                                    ) : (
                                                        <div style={styles.noPhoto}>Class</div>
                                                    )}
                                                </div>
                                                    );
                                                })}
                                            
                                            {/* Added Items Section */}
                                            {getAddedItems(order.id).length > 0 && (
                                                <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '2px dashed #eab308'}}>
                                                    <div style={{fontSize: '11px', color: '#eab308', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase'}}>âž• Added On-Site</div>
                                                    {getAddedItems(order.id).map((item, idx) => (
                                                        <div key={idx} style={{...styles.packageItem, background: '#1a2e1a', border: '1px solid #22c55e'}}>
                                                            <input
                                                                type="checkbox"
                                                                checked={!!getAddedItemPhotoNumber(order.id, idx)}
                                                                onChange={() => {}}
                                                            />
                                                            <div style={styles.packageInfo}>
                                                                <div style={styles.packageName}>{item.name} <span style={{color: '#22c55e', fontSize: '10px'}}>(ADDED)</span></div>
                                                                <div style={styles.packageDesc}>{item.desc}</div>
                                                            </div>
                                                            <div style={styles.packagePrice}>${item.price}</div>
                                                            {item.needsPhoto ? (
                                                                <input
                                                                    type="text"
                                                                    placeholder="#"
                                                                    style={styles.photoInput}
                                                                    value={getAddedItemPhotoNumber(order.id, idx)}
                                                                    onChange={e => setAddedItemPhotoNumber(order.id, idx, e.target.value)}
                                                                />
                                                            ) : (
                                                                <div style={styles.noPhoto}>No photo</div>
                                                            )}
                                                            <button
                                                                onClick={() => removeAddedItem(order.id, idx)}
                                                                style={{
                                                                    background: '#7f1d1d',
                                                                    color: '#fca5a5',
                                                                    border: 'none',
                                                                    borderRadius: '4px',
                                                                    padding: '4px 8px',
                                                                    fontSize: '10px',
                                                                    cursor: 'pointer',
                                                                    marginLeft: '8px'
                                                                }}
                                                            >
                                                                âœ•
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {/* Edit Picture Day */}
                                            <div style={{marginTop: '12px', padding: '12px', background: '#1e293b', borderRadius: '8px', border: '1px solid #334155'}}>
                                                <div style={{fontSize: '11px', color: '#64748b', marginBottom: '8px', textTransform: 'uppercase'}}>ðŸ“… Picture Day</div>
                                                <div style={{display: 'flex', gap: '8px', alignItems: 'center'}}>
                                                    <input
                                                        type="text"
                                                        placeholder="Enter date (e.g., 4 December)"
                                                        value={getDisplayPictureDay(order)}
                                                        onChange={e => setPictureDayOverride(order.id, e.target.value)}
                                                        style={{
                                                            flex: 1,
                                                            padding: '10px',
                                                            background: '#0f172a',
                                                            border: '1px solid #334155',
                                                            borderRadius: '6px',
                                                            color: '#e2e8f0',
                                                            fontSize: '14px'
                                                        }}
                                                    />
                                                    {getPictureDayOverride(order.id) !== undefined && (
                                                        <button
                                                            onClick={() => setPictureDayOverride(order.id, undefined)}
                                                            style={{
                                                                padding: '10px 12px',
                                                                background: '#7f1d1d',
                                                                color: '#fca5a5',
                                                                border: 'none',
                                                                borderRadius: '6px',
                                                                fontSize: '12px',
                                                                cursor: 'pointer'
                                                            }}
                                                        >
                                                            Reset
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Add Item Button */}
                                            <button
                                                onClick={() => {
                                                    setAddItemOrderId(order.id);
                                                    setShowAddItemModal(true);
                                                }}
                                                style={{
                                                    width: '100%',
                                                    padding: '12px',
                                                    marginTop: '12px',
                                                    background: '#1e3a5f',
                                                    color: '#60a5fa',
                                                    border: '2px dashed #3b82f6',
                                                    borderRadius: '8px',
                                                    fontSize: '14px',
                                                    fontWeight: '600',
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    gap: '8px'
                                                }}
                                            >
                                                âž• Add Item to Order
                                            </button>
                                            
                                            {order.buddyName && (
                                                <div style={styles.buddyBox}>
                                                    <div style={styles.buddyLabel}>Buddy / DS Name</div>
                                                    <div>{order.buddyName}</div>
                                                </div>
                                            )}
                                            
                                            {order.customRequest && (
                                                <div style={{...styles.buddyBox, marginTop: '8px'}}>
                                                    <div style={styles.buddyLabel}>Custom Request</div>
                                                    <div style={{fontSize: '13px'}}>{order.customRequest}</div>
                                                </div>
                                            )}
                                            
                                            <div style={styles.actionBtns}>
                                                <button
                                                    style={styles.completeBtn(isCompleted(order.id))}
                                                    onClick={() => toggleComplete(order.id)}
                                                >
                                                    {isCompleted(order.id) ? 'â†©ï¸ Unmark Shot' : 'âœ“ Mark Shot'}
                                                </button>
                                                <button
                                                    style={styles.paidBtn(isPaid(order.id))}
                                                    onClick={() => togglePaid(order.id)}
                                                >
                                                    {isPaid(order.id) ? 'â†©ï¸ Undo Paid' : 'ðŸ’µ Mark Paid'}
                                                </button>
                                            </div>
                                            <div style={{display: 'flex', gap: '8px', marginTop: '8px'}}>
                                                <button
                                                    style={{
                                                        flex: 1,
                                                        padding: '10px',
                                                        background: '#374151',
                                                        color: '#9ca3af',
                                                        border: 'none',
                                                        borderRadius: '8px',
                                                        fontSize: '12px',
                                                        cursor: 'pointer'
                                                    }}
                                                    onClick={() => hideOrder(order.id)}
                                                >
                                                    ðŸ‘ï¸ Hide (Local Only)
                                                </button>
                                                <button
                                                    style={{
                                                        flex: 1,
                                                        padding: '10px',
                                                        background: '#7f1d1d',
                                                        color: '#fca5a5',
                                                        border: 'none',
                                                        borderRadius: '8px',
                                                        fontSize: '12px',
                                                        cursor: 'pointer'
                                                    }}
                                                    onClick={() => deleteOrder(order.id, order.name)}
                                                >
                                                    ðŸ—‘ï¸ Delete (Permanent)
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))
                        ) : (
                            filteredOrders.map(order => {
                                const photoNums = Object.entries(localData[order.id]?.photoNumbers || {})
                                    .filter(([k, v]) => v)
                                    .map(([k, v]) => `${k}: ${v}`)
                                    .join(', ');
                                
                                return (
                                    <div key={order.id} style={{...styles.deliveryCard, borderLeft: isPaid(order.id) ? '4px solid #22c55e' : '4px solid #ef4444'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '8px'}}>
                                            <div>
                                                <div style={{fontSize: '16px', fontWeight: '600'}}>{order.name}</div>
                                                <div style={{fontSize: '12px', color: '#64748b'}}>{order.platoon}</div>
                                            </div>
                                            <div style={{textAlign: 'right'}}>
                                                {editingPriceId === order.id ? (
                                                    <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                                        <span style={{color: '#64748b', fontSize: '14px'}}>$</span>
                                                        <input
                                                            type="number"
                                                            step="0.01"
                                                            value={editingPriceValue}
                                                            onChange={e => setEditingPriceValue(e.target.value)}
                                                            placeholder="Subtotal"
                                                            style={{
                                                                width: '80px',
                                                                padding: '6px',
                                                                background: '#0f172a',
                                                                border: '1px solid #eab308',
                                                                borderRadius: '4px',
                                                                color: '#fff',
                                                                fontSize: '16px',
                                                                textAlign: 'right'
                                                            }}
                                                            autoFocus
                                                        />
                                                        <button
                                                            onClick={() => {
                                                                const val = parseFloat(editingPriceValue);
                                                                if (!isNaN(val) && val >= 0) {
                                                                    setPriceOverride(order.id, val);
                                                                }
                                                                setEditingPriceId(null);
                                                                setEditingPriceValue('');
                                                            }}
                                                            style={{
                                                                padding: '6px 10px',
                                                                background: '#22c55e',
                                                                color: '#fff',
                                                                border: 'none',
                                                                borderRadius: '4px',
                                                                fontSize: '12px',
                                                                cursor: 'pointer'
                                                            }}
                                                        >
                                                            âœ“
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                setEditingPriceId(null);
                                                                setEditingPriceValue('');
                                                            }}
                                                            style={{
                                                                padding: '6px 10px',
                                                                background: '#64748b',
                                                                color: '#fff',
                                                                border: 'none',
                                                                borderRadius: '4px',
                                                                fontSize: '12px',
                                                                cursor: 'pointer'
                                                            }}
                                                        >
                                                            âœ•
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <div 
                                                            style={{fontSize: '22px', fontWeight: 'bold', color: isPaid(order.id) ? '#22c55e' : '#eab308', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'flex-end', gap: '6px'}}
                                                            onClick={() => {
                                                                const override = getPriceOverride(order.id);
                                                                setEditingPriceValue(override ? override.subtotal.toFixed(2) : order.subtotal.toFixed(2));
                                                                setEditingPriceId(order.id);
                                                            }}
                                                        >
                                                            ${getDisplayTotal(order).toFixed(2)}
                                                            <span style={{fontSize: '12px', color: '#64748b'}}>âœï¸</span>
                                                        </div>
                                                        {getPriceOverride(order.id) && (
                                                            <div 
                                                                style={{fontSize: '10px', color: '#f59e0b', cursor: 'pointer'}}
                                                                onClick={() => clearPriceOverride(order.id)}
                                                            >
                                                                (modified - tap to reset)
                                                            </div>
                                                        )}
                                                        <div style={{fontSize: '11px', color: isPaid(order.id) ? '#22c55e' : '#ef4444', fontWeight: '600'}}>
                                                            {isPaid(order.id) ? 'âœ“ PAID' : 'COLLECT'}
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                        <div style={{fontSize: '12px', color: '#94a3b8'}}>
                                            {order.packages.map(p => p.code).join(', ')}
                                        </div>
                                        {photoNums && (
                                            <div style={{marginTop: '8px', paddingTop: '8px', borderTop: '1px solid #334155', fontSize: '12px'}}>
                                                <span style={{color: '#eab308', fontWeight: '600'}}>Photos:</span> {photoNums}
                                            </div>
                                        )}
                                        <button
                                            style={{...styles.paidBtn(isPaid(order.id)), width: '100%', marginTop: '12px'}}
                                            onClick={() => togglePaid(order.id)}
                                        >
                                            {isPaid(order.id) ? 'â†©ï¸ Undo Paid' : 'ðŸ’µ Mark Paid'}
                                        </button>
                                    </div>
                                );
                            })
                        )}
                    </div>

                    {/* Product Totals Modal */}
                    {showProductTotals && (
                        <div className="modal-overlay" onClick={() => setShowProductTotals(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <div className="modal-title">ðŸ“¦ Products to Order</div>
                                    <button className="modal-close" onClick={() => setShowProductTotals(false)}>Ã—</button>
                                </div>
                                <div className="modal-body">
                                    <p style={{color: '#64748b', fontSize: '13px', marginBottom: '16px'}}>
                                        Based on {filteredOrders.length} filtered orders
                                    </p>
                                    {Object.keys(productTotals).sort().map(product => (
                                        <div key={product} className="product-row">
                                            <span className="product-name">{product}</span>
                                            <span className="product-count">{productTotals[product]}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Fulfillment Modal */}
                    {showFulfillment && (
                        <div className="modal-overlay" onClick={() => setShowFulfillment(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <div className="modal-title">ðŸ“‹ Fulfillment List</div>
                                    <button className="modal-close" onClick={() => setShowFulfillment(false)}>Ã—</button>
                                </div>
                                <div className="modal-body">
                                    <button 
                                        style={{...styles.btn, marginBottom: '16px', width: '100%', justifyContent: 'center'}}
                                        onClick={exportFulfillment}
                                    >
                                        ðŸ’¾ Export Fulfillment CSV
                                    </button>
                                    {Object.keys(fulfillmentData).sort().map(product => (
                                        <div key={product} className="fulfillment-section">
                                            <div className="fulfillment-title">{product} ({fulfillmentData[product].length})</div>
                                            {fulfillmentData[product].map((item, idx) => (
                                                <div key={idx} className="fulfillment-item">
                                                    <strong>{item.name}</strong>
                                                    {item.photoNumber && <span className="fulfillment-photo"> â€” Photo #{item.photoNumber}</span>}
                                                    {item.buddyName && <span style={{color: '#64748b'}}> (with {item.buddyName})</span>}
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Review Request Modal */}
                    {showReviewModal && reviewOrder && (
                        <div className="modal-overlay" onClick={skipReview}>
                            <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth: '400px'}}>
                                <div className="modal-header">
                                    <div className="modal-title">â­ Request Review</div>
                                    <button className="modal-close" onClick={skipReview}>Ã—</button>
                                </div>
                                <div className="modal-body">
                                    <p style={{marginBottom: '16px', color: '#94a3b8'}}>
                                        Send <strong style={{color: '#e2e8f0'}}>{reviewOrder.name}</strong> a text asking for a Google review?
                                    </p>
                                    
                                    <label style={{display: 'block', marginBottom: '8px', fontSize: '12px', color: '#64748b', textTransform: 'uppercase'}}>
                                        Phone Number
                                    </label>
                                    <input
                                        type="tel"
                                        value={reviewPhone}
                                        onChange={e => setReviewPhone(e.target.value)}
                                        placeholder="(555) 123-4567"
                                        style={{
                                            width: '100%',
                                            padding: '14px',
                                            background: '#0f172a',
                                            border: '2px solid #334155',
                                            borderRadius: '8px',
                                            color: '#fff',
                                            fontSize: '18px',
                                            textAlign: 'center',
                                            marginBottom: '8px'
                                        }}
                                    />
                                    
                                    <p style={{fontSize: '12px', color: '#64748b', marginBottom: '20px'}}>
                                        They'll receive: "We appreciate a review: [link] . Thank you for trusting us."
                                    </p>
                                    
                                    <div style={{display: 'flex', gap: '10px'}}>
                                        <button
                                            onClick={skipReview}
                                            style={{
                                                flex: 1,
                                                padding: '14px',
                                                background: '#334155',
                                                color: '#94a3b8',
                                                border: 'none',
                                                borderRadius: '8px',
                                                fontSize: '14px',
                                                fontWeight: '600',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            Skip
                                        </button>
                                        <button
                                            onClick={sendReviewRequest}
                                            disabled={!reviewPhone || sendingReview}
                                            style={{
                                                flex: 2,
                                                padding: '14px',
                                                background: reviewPhone ? '#eab308' : '#334155',
                                                color: reviewPhone ? '#0f172a' : '#64748b',
                                                border: 'none',
                                                borderRadius: '8px',
                                                fontSize: '14px',
                                                fontWeight: '600',
                                                cursor: reviewPhone ? 'pointer' : 'not-allowed',
                                                opacity: sendingReview ? 0.7 : 1
                                            }}
                                        >
                                            {sendingReview ? 'â³ Sending...' : 'ðŸ“± Send Review Request'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add Item Modal */}
                    {showAddItemModal && addItemOrderId && (
                        <div className="modal-overlay" onClick={() => { setShowAddItemModal(false); setAddItemOrderId(null); }}>
                            <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth: '500px'}}>
                                <div className="modal-header">
                                    <div className="modal-title">âž• Add Item to Order</div>
                                    <button className="modal-close" onClick={() => { setShowAddItemModal(false); setAddItemOrderId(null); }}>Ã—</button>
                                </div>
                                <div className="modal-body">
                                    <p style={{marginBottom: '16px', color: '#94a3b8'}}>
                                        Select a package to add:
                                    </p>
                                    <div style={{display: 'flex', flexDirection: 'column', gap: '8px'}}>
                                        {Object.entries(FORM_CONFIG.packages).map(([code, pkg]) => (
                                            <button
                                                key={code}
                                                onClick={() => addItemToOrder(addItemOrderId, code)}
                                                style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                    padding: '14px 16px',
                                                    background: '#0f172a',
                                                    border: '1px solid #334155',
                                                    borderRadius: '8px',
                                                    cursor: 'pointer',
                                                    textAlign: 'left'
                                                }}
                                            >
                                                <div>
                                                    <div style={{color: '#e2e8f0', fontWeight: '600', fontSize: '14px'}}>{pkg.name}</div>
                                                    <div style={{color: '#64748b', fontSize: '12px'}}>{pkg.desc}</div>
                                                </div>
                                                <div style={{color: '#eab308', fontWeight: 'bold', fontSize: '16px'}}>
                                                    ${pkg.price}
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                    <p style={{marginTop: '16px', color: '#64748b', fontSize: '12px'}}>
                                        * 6% tax will be added automatically
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    
    <!-- Service Worker Registration for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('PVME Tracker: Service Worker registered', registration.scope);
                    })
                    .catch(error => {
                        console.log('PVME Tracker: Service Worker registration failed', error);
                    });
            });
        }
    </script>
</body>
</html>
